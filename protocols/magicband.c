
#include <stdlib.h>
#include <string.h>
#include "magicband.h"
#include "_protocols.h"

// ----------------------------- Utilities -----------------------------
static size_t build_adv(const uint8_t* mfg, size_t mlen, uint8_t* out) {
    uint8_t* p = out;
    // Flags: 02 01 06
    *p++ = 0x02; *p++ = 0x01; *p++ = 0x06;
    // Manufacturer Specific Data: len = 1(type)+2(company)+mlen
    *p++ = (uint8_t)(1 + 2 + mlen);
    *p++ = 0xFF;     // AD type: Manufacturer
    *p++ = 0x83;     // Disney company ID LSB (0x0183)
    *p++ = 0x01;     // Disney company ID MSB
    for(size_t i=0;i<mlen;i++) *p++ = mfg[i];
    return (size_t)(p - out);
}

static void build_e905(uint8_t color5, bool vibe, uint8_t out[9]) {
    // Single color from 5-bit palette (mask=000 all LEDs), timing 0x09, unk 0x0E
    out[0]=0xE1; out[1]=0x00; out[2]=0xE9; out[3]=0x05; out[4]=0x00;
    out[5]=0x09; out[6]=0x0E;
    out[7]=(uint8_t)((0u<<5) | (color5 & 0x1F));
    out[8]= vibe ? 0xB0 : 0x00; // upper nibble selects vibration palette
}

// ----------------------------- Example payloads (EMCOT) -----------------------------
// CC Broadcast
static const uint8_t CC_1[] = {0xE1,0x00,0xCC,0x03,0x00,0x00,0x00};
static const uint8_t CC_2[] = {0xE1,0x00,0xCC,0x03,0x00,0x01,0x00};
static const uint8_t CC_3[] = {0xE1,0x00,0xCC,0x03,0x13,0x20,0x00};

typedef struct { const char* name; const uint8_t* data; size_t len; } Entry;

static const Entry CAT_CC[] = {
    {"CC 03 00 00 00 (Ping)", CC_1, sizeof(CC_1)},
    {"CC 03 00 01 00", CC_2, sizeof(CC_2)},
    {"CC 03 13 20 00", CC_3, sizeof(CC_3)},
};

// E906
static const uint8_t E906_EX1[] = {0xE2,0x00,0xE9,0x06,0x00,0x22,0x0F,0x44,0x41,0xB0};
static const Entry CAT_E906[] = { {"E9-06 Dual Palette (ex1)", E906_EX1, sizeof(E906_EX1)} };

// E907
static const uint8_t E907_EX1[] = {0xE2,0x00,0xE9,0x07,0x00,0x22,0x0F,0x43,0x43,0x41,0xB0};
static const uint8_t E907_EX2[] = {0xE2,0x00,0xE9,0x07,0x00,0x22,0x0F,0x44,0x44,0x41,0xB0};
static const Entry CAT_E907[] = {
    {"E9-07 Unknown (ex1)", E907_EX1, sizeof(E907_EX1)},
    {"E9-07 Unknown (ex2)", E907_EX2, sizeof(E907_EX2)},
};

// E908
static const uint8_t E908_EX1[] = {0xE1,0x00,0xE9,0x08,0x00,0x0E,0xD2,0x55,0x7C,0x7C,0x7C,0xB0};
static const Entry CAT_E908[] = { {"E9-08 Single 6-bit (ex1)", E908_EX1, sizeof(E908_EX1)} };

// E909
static const uint8_t E909_EX1[] = {0xE1,0x00,0xE9,0x09,0x00,0x0E,0x0F,0xBC,0xB5,0xB9,0xA4,0xA7,0xB0};
static const Entry CAT_E909[] = { {"E9-09 5-Color Palette (ex1)", E909_EX1, sizeof(E909_EX1)} };

// E90B
static const uint8_t E90B_EX1[] = {0xE1,0x00,0xE9,0x0B,0x0B,0x0F,0x0F,0x5C,0x5D,0x48,0xA5,0xD1,0x45,0x32,0x05};
static const Entry CAT_E90B[] = { {"E9-0B Circle (ex1)", E90B_EX1, sizeof(E90B_EX1)} };

// E90C
static const uint8_t E90C_BLINK_WHITE[]   = {0xE1,0x00,0xE9,0x0C,0x00,0x0F,0x0F,0x5D,0x46,0x5B,0xF0,0x05,0x32,0x37,0x48,0x95};
static const uint8_t E90C_ORANGE_BLINK[]  = {0xE1,0x00,0xE9,0x0C,0x00,0xEF,0x0F,0x4F,0x4F,0x5B,0xF0,0xFB,0x14,0x37,0x48,0x95};
static const uint8_t E90C_5PALETTE[]      = {0xE1,0x00,0xE9,0x0C,0x00,0x0F,0x0F,0xB1,0xB9,0xB5,0xB1,0xA2,0x30,0x7B,0x7D,0xB0};
static const uint8_t E90C_TASTE_RAINBOW[] = {0xE1,0x00,0xE9,0x0C,0x00,0x0F,0x0F,0x5D,0x46,0x5B,0xF0,0x05,0x32,0x37,0x48,0xB0};
static const Entry CAT_E90C[] = {
    {"E9-0C Blink White", E90C_BLINK_WHITE, sizeof(E90C_BLINK_WHITE)},
    {"E9-0C Orange Blink", E90C_ORANGE_BLINK, sizeof(E90C_ORANGE_BLINK)},
    {"E9-0C 5-Color Cycle", E90C_5PALETTE, sizeof(E90C_5PALETTE)},
    {"E9-0C Taste the Rainbow", E90C_TASTE_RAINBOW, sizeof(E90C_TASTE_RAINBOW)},
};

// E90E
static const uint8_t E90E_1[] = {0xE1,0x00,0xE9,0x0E,0x00,0x01,0x0F,0xBD,0xA0,0xA0,0xBD,0xA0,0x59,0x07,0x00,0x48,0xAE,0xB5};
static const uint8_t E90E_2[] = {0xE1,0x00,0xE9,0x0E,0x00,0x02,0x0F,0xBC,0xA0,0xBC,0xA0,0xBC,0x59,0x17,0xFB,0x48,0xAE,0xBB};
static const uint8_t E90E_3[] = {0xE1,0x00,0xE9,0x0E,0x00,0x11,0x0F,0xBC,0xA7,0xB9,0xA7,0xB9,0x59,0x19,0x02,0x48,0xAE,0xB0};
static const uint8_t E90E_4[] = {0xE1,0x00,0xE9,0x0E,0x00,0x15,0x0F,0xBB,0xBB,0xBB,0xBB,0x59,0x19,0x02,0x48,0xAE,0xB0};
static const uint8_t E90E_5[] = {0xE1,0x00,0xE9,0x0E,0x00,0x83,0x0F,0xB5,0xB9,0xB2,0xAD,0xB6,0x59,0x19,0x0B,0x48,0xAE,0xB0};
static const Entry CAT_E90E[] = {
    {"E9-0E ex1", E90E_1, sizeof(E90E_1)},
    {"E9-0E ex2", E90E_2, sizeof(E90E_2)},
    {"E9-0E ex3", E90E_3, sizeof(E90E_3)},
    {"E9-0E ex4", E90E_4, sizeof(E90E_4)},
    {"E9-0E ex5", E90E_5, sizeof(E90E_5)},
};

// E90F
static const uint8_t E90F_1[] = {0xE1,0x00,0xE9,0x0F,0x00,0x11,0x0F,0x4F,0x42,0x58,0x07,0x48,0x8D,0xD2,0x46,0x2A,0x07,0x17,0xB8};
static const uint8_t E90F_2[] = {0xE1,0x00,0xE9,0x0F,0x00,0x2A,0x0F,0x46,0x43,0x58,0x12,0x48,0x8D,0xD2,0x46,0x02,0x12,0x00,0xB0};
static const Entry CAT_E90F[] = {
    {"E9-0F ex1", E90F_1, sizeof(E90F_1)},
    {"E9-0F ex2", E90F_2, sizeof(E90F_2)},
};

// E910
static const uint8_t E910_1[] = {0xE1,0x00,0xE9,0x10,0x00,0x13,0x48,0x97,0xD0,0x0E,0xA0,0xD1,0x46,0x06,0x0F,0x30,0xD0,0x4E,0x07,0xB0};
static const Entry CAT_E910[] = {
    {"E9-10 Alternating Colors (ex1)", E910_1, sizeof(E910_1)},
};

// E911
static const uint8_t E911_1[] = {0xE1,0x00,0xE9,0x11,0x00,0x6F,0x0F,0x56,0x48,0x58,0xF4,0x48,0x82,0xD1,0x46,0x02,0x08,0xD0,0x65,0x00,0xB0};
static const uint8_t E911_2[] = {0xE2,0x00,0xE9,0x11,0x00,0x4F,0x0F,0x44,0x4F,0x58,0xF4,0x48,0x82,0xD1,0x46,0x06,0x07,0xD0,0x65,0x43,0xB0};
static const uint8_t E911_3[] = {0xE1,0x00,0xE9,0x11,0x00,0x0F,0x0F,0x48,0x59,0x58,0xF4,0x48,0x82,0xD1,0x46,0x02,0x0D,0xD0,0x65,0x05,0xB0};
static const uint8_t E911_4[] = {0xE2,0x00,0xE9,0x11,0x00,0x4F,0x0F,0x4F,0x55,0x58,0xF4,0x48,0x82,0xD1,0x46,0x02,0x2A,0xD0,0x65,0x01,0xB0};
static const uint8_t E911_5[] = {0xE1,0x00,0xE9,0x11,0x00,0x01,0x0F,0x5A,0x47,0x5B,0xF0,0x31,0x34,0x37,0x48,0x94,0xD1,0x3D,0x05,0x07,0xB0};
static const uint8_t E911_6[] = {0xE1,0x00,0xE9,0x11,0x00,0x07,0x0F,0x55,0x5D,0x58,0xF4,0x48,0x82,0xD1,0x46,0x05,0x08,0xD0,0x65,0x00,0xB0};
static const uint8_t E911_7[] = {0xE1,0x00,0xE9,0x11,0x00,0x44,0x0F,0x51,0x42,0x58,0xF4,0x48,0x82,0xD1,0x46,0x05,0x0F,0xD0,0x65,0x00,0xB0};
static const Entry CAT_E911[] = {
    {"E9-11 Cross Fade (ex1)", E911_1, sizeof(E911_1)},
    {"E9-11 Cross Fade (ex2)", E911_2, sizeof(E911_2)},
    {"E9-11 Cross Fade (ex3)", E911_3, sizeof(E911_3)},
    {"E9-11 Cross Fade (ex4)", E911_4, sizeof(E911_4)},
    {"E9-11 Cross Fade (ex5)", E911_5, sizeof(E911_5)},
    {"E9-11 Cross Fade (ex6)", E911_6, sizeof(E911_6)},
    {"E9-11 Cross Fade (ex7)", E911_7, sizeof(E911_7)},
};

// E912
static const uint8_t E912_EX1[] = {0xE1,0x00,0xE9,0x12,0x00,0x01,0x0F,0xBC,0xBD,0xBD,0xBD,0xBD,0x30,0xD0,0x37,0xF4,0xD2,0x46,0x00,0x00,0xFC,0xBB};
static const uint8_t E912_EX2[] = {0xE1,0x00,0xE9,0x12,0x00,0x01,0x29,0x04,0x02,0x02,0x11,0x11,0x48,0x96,0xD0,0x0E,0xFF,0xD1,0x46,0x07,0x07,0xB0};
static const uint8_t E912_EX3[] = {0xE2,0x00,0xE9,0x12,0x00,0x03,0x0F,0xA2,0xA2,0xA4,0xA4,0xA2,0x30,0xD0,0x37,0xF4,0xD2,0x46,0x00,0x64,0xFC,0xB0};
static const Entry CAT_E912[] = {
    {"E9-12 Circle + Vibe (ex1)", E912_EX1, sizeof(E912_EX1)},
    {"E9-12 Circle + Vibe (ex2)", E912_EX2, sizeof(E912_EX2)},
    {"E9-12 Circle + Vibe (ex3)", E912_EX3, sizeof(E912_EX3)},
};

// E913
static const uint8_t E913_1[] = {0xE1,0x00,0xE9,0x13,0x00,0x02,0xD0,0x37,0xF0,0xD2,0x3D,0x05,0x05,0x00,0x0E,0xFA,0x89,0x83,0x51,0x0E,0xE7,0xA0,0xB0};
static const uint8_t E913_2[] = {0xE2,0x00,0xE9,0x13,0x00,0x65,0x0F,0xBD,0xB5,0xBC,0xB5,0xBC,0x7A,0xEC,0x5C,0x0A,0x29,0x15,0x29,0x15,0x48,0xAB,0xB0};
static const Entry CAT_E913[] = {
    {"E9-13 Animation (ex1)", E913_1, sizeof(E913_1)},
    {"E9-13 Animation (ex2)", E913_2, sizeof(E913_2)},
};

// E914
static const uint8_t E914_1[] = {0xE1,0x00,0xE9,0x14,0x00,0x0C,0xD0,0x37,0xF0,0xD2,0x3D,0x05,0x0C,0x0C,0x0E,0xEC,0x89,0x83,0x51,0x0E,0xEE,0x0C,0x3D,0xB0};
static const uint8_t E914_2[] = {0xE2,0x00,0xE9,0x14,0x00,0x2C,0xD0,0x37,0xF0,0xD2,0x3D,0x02,0x12,0x00,0x0E,0xEA,0x89,0x83,0x51,0x0E,0xE3,0x0C,0x1E,0xB0};
static const uint8_t E914_3[] = {0xE2,0x00,0xE9,0x14,0x00,0x42,0x0F,0x55,0x5B,0x58,0xF4,0x48,0x82,0xD0,0x65,0x1B,0xD1,0x46,0x2A,0x02,0x30,0x7B,0x5D,0xB0};
static const Entry CAT_E914[] = {
    {"E9-14 Animation (ex1)", E914_1, sizeof(E914_1)},
    {"E9-14 Animation (ex2)", E914_2, sizeof(E914_2)},
    {"E9-14 Animation (ex3)", E914_3, sizeof(E914_3)},
};

// ----------------------------- Protocol impl -----------------------------
static const char* get_name(const Payload* payload) {
    UNUSED(payload);
    return "MagicBand+";
}

static void make_packet(uint8_t* _size, uint8_t** _packet, Payload* payload) {
    MagicbandCfg* cfg = &payload->cfg.magicband;
    uint8_t adv[31]; size_t adv_len = 0;

    switch(cfg->category) {
    default:
    case MB_Cat_CC: {
        const Entry* arr = CAT_CC;
        uint8_t i = cfg->index % (sizeof(CAT_CC)/sizeof(CAT_CC[0]));
        adv_len = build_adv(arr[i].data, arr[i].len, adv);
        break;
    }
    case MB_Cat_E905_Single: {
        uint8_t e905[9]; build_e905(cfg->color5 & 0x1F, cfg->vibe_on, e905);
        adv_len = build_adv(e905, sizeof(e905), adv);
        break;
    }
    case MB_Cat_E906_Dual:    { const Entry* arr = CAT_E906;  uint8_t i = cfg->index % (sizeof(CAT_E906)/sizeof(CAT_E906[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E907_Unknown: { const Entry* arr = CAT_E907;  uint8_t i = cfg->index % (sizeof(CAT_E907)/sizeof(CAT_E907[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E908_6bit:    { const Entry* arr = CAT_E908;  uint8_t i = cfg->index % (sizeof(CAT_E908)/sizeof(CAT_E908[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E909_5Palette: { const Entry* arr = CAT_E909; uint8_t i = cfg->index % (sizeof(CAT_E909)/sizeof(CAT_E909[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E90B_Circle:  { const Entry* arr = CAT_E90B;  uint8_t i = cfg->index % (sizeof(CAT_E90B)/sizeof(CAT_E90B[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E90C_Animations: { const Entry* arr = CAT_E90C; uint8_t i = cfg->index % (sizeof(CAT_E90C)/sizeof(CAT_E90C[0])); adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E90E_Examples: { const Entry* arr = CAT_E90E; uint8_t i = cfg->index % (sizeof(CAT_E90E)/sizeof(CAT_E90E[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E90F_Examples: { const Entry* arr = CAT_E90F; uint8_t i = cfg->index % (sizeof(CAT_E90F)/sizeof(CAT_E90F[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E910_Alternating: { const Entry* arr = CAT_E910; uint8_t i = cfg->index % (sizeof(CAT_E910)/sizeof(CAT_E910[0])); adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E911_Crossfade: { const Entry* arr = CAT_E911; uint8_t i = cfg->index % (sizeof(CAT_E911)/sizeof(CAT_E911[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E912_CircleVibe: { const Entry* arr = CAT_E912; uint8_t i = cfg->index % (sizeof(CAT_E912)/sizeof(CAT_E912[0])); adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E913_Examples: { const Entry* arr = CAT_E913; uint8_t i = cfg->index % (sizeof(CAT_E913)/sizeof(CAT_E913[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    case MB_Cat_E914_Examples: { const Entry* arr = CAT_E914; uint8_t i = cfg->index % (sizeof(CAT_E914)/sizeof(CAT_E914[0]));   adv_len = build_adv(arr[i].data, arr[i].len, adv); break; }
    }

    *_size = adv_len;
    *_packet = (uint8_t*)malloc(adv_len);
    memcpy(*_packet, adv, adv_len);
}

// Only toggle we expose in Config: Vibration (for E9-05 entries)
static void on_bool(VariableItem* item) {
    bool* value = variable_item_get_context(item);
    *value = variable_item_get_current_value_index(item);
    variable_item_set_current_value_text(item, *value ? "ON" : "OFF");
}

static void extra_config(Ctx* ctx) {
    Payload* payload = &ctx->attack->payload;
    MagicbandCfg* cfg = &payload->cfg.magicband;
    if(cfg->category == MB_Cat_E905_Single) {
        VariableItem* item = variable_item_list_add(ctx->variable_item_list, "Vibration", 2, on_bool, &cfg->vibe_on);
        variable_item_set_current_value_index(item, cfg->vibe_on ? 1 : 0);
        variable_item_set_current_value_text(item, cfg->vibe_on ? "ON" : "OFF");
    }
}

static uint8_t config_count(const Payload* payload) {
    if(payload->cfg.magicband.category == MB_Cat_E905_Single) return 1;
    return 0;
}

const Protocol protocol_magicband = {
    .icon = &I_ble,
    .get_name = get_name,
    .make_packet = make_packet,
    .extra_config = extra_config,
    .config_count = config_count,
};
